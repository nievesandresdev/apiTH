name: Build and Push API Image

on:
  push:
    branches: [ main, test ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # Checkout del c√≥digo
      - name: Checkout
        uses: actions/checkout@v3

      
      - name: Purge Cloudflare cache for ALL zones
        if: github.ref_name == 'main'
        env:
              CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}   # guarda tu token aqu√≠
        run: |
            echo "üîç Obteniendo lista de zonas de Cloudflare‚Ä¶"
            zones=$(curl -s -H "Authorization: Bearer $CF_API_TOKEN" \
                          -H "Content-Type: application/json" \
                            "https://api.cloudflare.com/client/v4/zones" | jq -r '.result[].id')
        
            for zone in $zones; do
                echo "üßπ Purging cache in zone $zone"
                curl -s -X POST "https://api.cloudflare.com/client/v4/zones/$zone/purge_cache" \
                    -H "Authorization: Bearer $CF_API_TOKEN" \
                    -H "Content-Type: application/json" \
                    --data '{"purge_everything":true}' | jq -r '. | {zone_result: .success}'
            done
            
      - name: Install redis-cli
        run: |
          sudo apt-get update
          sudo apt-get install -y redis-tools

      - name: Purge Redis cache keys
        env:
          REDIS_HOST: th-api.redis.cache.windows.net
          REDIS_PORT: 6380
          REDIS_PASSWORD: ${{ vars.REDIS_PASSWORD }}
        run: |
          # Determina el prefijo seg√∫n la rama
          if [ "${{ github.ref_name }}" = "main" ]; then
            PREFIX="thehoster_database_thehoster_cache_:hotel_prod_main"
          else
            PREFIX="thehoster_database_thehoster_cache_:hotel_prod_test"
          fi
    
          echo "üîë Deleting Redis keys matching ${PREFIX}* ‚Ä¶"
    
          # Usamos SCAN para no bloquear producci√≥n; xargs invoca DEL por lotes
          redis-cli --tls -h "$REDIS_HOST" -p "$REDIS_PORT" -a "$REDIS_PASSWORD" \
            --scan --pattern "${PREFIX}*" \
            | xargs -r redis-cli --tls -h "$REDIS_HOST" -p "$REDIS_PORT" -a "$REDIS_PASSWORD" -n 1 DEL
    
          echo "‚úÖ Done purging Redis."
