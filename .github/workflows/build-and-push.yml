name: Build and Push API Image

on:
  push:
    branches: [ main, test ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # Checkout del cÃ³digo
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install redis-cli
        run: |
          sudo apt-get update
          sudo apt-get install -y redis-tools

      - name: Purge Redis cache keys
        env:
          REDIS_HOST: th-api.redis.cache.windows.net
          REDIS_PORT: 6380
          REDIS_PASSWORD: ${{ vars.REDIS_PASSWORD }}
        run: |
          # 1) Instalar redis-cli ya hecho arriba.

          # 2) Elegir sÃ³lo el prefijo, sin comodines
          if [ "${{ github.ref_name }}" = "main" ]; then
            PREFIX="thehoster_database_thehoster_cache_:hotel_prod_main"
          else
            PREFIX="thehoster_database_thehoster_cache_:hotel_prod_test"
          fi

          echo "ðŸ”‘ Deleting Redis keys matching ${PREFIX}* â€¦"

          # OpciÃ³n DEBUG: ver quÃ© password se estÃ¡ usando
          # echo "Using REDIS_PASSWORD='$REDIS_PASSWORD'" >&2

          # 3) Scan en la DB 1 y borrado por lotes con xargs
          redis-cli --tls \
            -h "$REDIS_HOST" -p "$REDIS_PORT" -a "$REDIS_PASSWORD" -n 1 \
            --scan --pattern "${PREFIX}*" \
          | xargs -r redis-cli --tls \
            -h "$REDIS_HOST" -p "$REDIS_PORT" -a "$REDIS_PASSWORD" -n 1 DEL

          echo "âœ… Done purging Redis."

